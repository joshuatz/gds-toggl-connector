import 'google-apps-script';
import {getUserApiKey} from './auth';
import { TogglApi } from './toggl';

/**
 * @author Joshua Tzucker
 * Note: @override is used to denote function that is required and expected by connector implementation
 */

interface SchemaRequest {
    "configParams" : object,
    "scriptParams" : object
}

interface FieldObjNameOnly {
    "name" : string
}
/**
 * https://developers.google.com/datastudio/connector/reference#request_example_3
 * Note: Fields correspond to names provided by getSchema/getFields
 */
interface GetDataRequest {
    "configParams": object,
    "scriptParams": {
        "sampleExtraction"?: boolean,
        "lastRefresh": string
    },
    "dateRange": {
        "startDate": string,
        "endDate": string
    },
    "fields": Array<FieldObjNameOnly>
}

interface DataReturnObjRow {
    "values" : Array<any>
}

interface DataReturnObjSchema {
    "name" : string,
    "dataType": string
}
interface GetDataReturnObj {
    "schema" : Array<DataReturnObjSchema>,
    "rows" : Array<DataReturnObjRow>,
    "cachedData" : boolean
}

/**
 * Some app-wide constants
 */
var AUTH_HELP_URL = 'https://toggl.com/app/profile';
var APIKEY_STORAGE = 'dscc.key';
var IS_DEBUG:boolean = true;
var APP_USER_AGENT: string = 'https://github.com/joshuatz/gds-toggl-connector'
/**
 * MAIN - Setup globals
 */
// init connector
var cc = DataStudioApp.createCommunityConnector();
// Create global instance of toggl api class
export var togglApiInst = new TogglApi(getUserApiKey());

/**
 * @override
 * This is used by Data Studio to build the configuration UI screen that the user enters settings on first run
 */
function getConfig() {
	// Get config obj provided by gds-connector
	let config = cc.getConfig();

	// Set config general info
	config.newInfo()
		.setId('instructions')
        .setText('Configure the connector for Toggl');
    
    // Require workspace ID (necessary for all report API calls)
    config.newTextInput()
        .setId('workspaceId')
        .setName('Toggl Workspace ID')
        .setHelpText('Numerical ID for your workspace')
        .setPlaceholder('123456');

    // Allow pre-filtering to just billable time
    config.newCheckbox()
        .setId('prefilterBillable')
        .setName('Pre-filter Billable')
        .setHelpText('Pre-filter all reports to just "billable" time (as configured in Toggl)');

    // Require date range to be sent with every data request
    config.setDateRangeRequired(true);

	// Make sure to return the built config
	return config.build();
}

/**
 * @override
 * Kept as separate function from getSchema, so it can be reused with getData()
 * https://developers.google.com/datastudio/connector/reference#getschema
 * List of types: https://developers.google.com/datastudio/connector/reference#datatype
 */
function getFields(){
    let fields = cc.getFields();
    let types = cc.FieldType;
    let aggregations = cc.AggregationType;

    // Default date/time dimension
    fields
        .newDimension()
        .setId('day')
        .setName('Date')
        .setType(types.YEAR_MONTH_DAY);

    fields
        .newDimension()
        .setId('projectId')
        .setName('Project Id')
        .setDescription('Numerical ID generated by Toggl for each project')
        .setType(types.NUMBER);

    fields
        .newMetric()
        .setId('time')
        .setName('time')
        .setDescription('Logged Time')
        .setType(types.DURATION)

    return fields;
}

/**
 * @override
 */
function getSchema(request:SchemaRequest) {
    return {schema : getFields().build()};
}

/**
 * @override
 * https://developers.google.com/datastudio/connector/reference#getdata
 * Should return: https://developers.google.com/datastudio/connector/reference#response_3
 *   - Schema and rows should match
 *   - Response should match what was requested {request.fields}
 */
function getData(request:GetDataRequest){
    Logger.log(request);
    let requestedFieldNames: Array<string> = request.fields.map(field=>field.name);
    let requestedFields: GoogleAppsScript.Data_Studio.Fields = getFields().forIds(requestedFieldNames);
    let returnData: GetDataReturnObj = {
        "cachedData" : false,
        "schema" : [
            {
                "name" : "",
                "dataType" : ""
            }
        ],
        "rows" : [
            {
                "values" : []
            }
        ]
    }
    let lastRefreshedTime:Date = new Date(request.scriptParams.lastRefresh);
    let dateRangeStart:Date = new Date(request.dateRange.startDate);
    let dateRangeEnd:Date = new Date(request.dateRange.endDate);

    // @TODO
    return returnData;
}